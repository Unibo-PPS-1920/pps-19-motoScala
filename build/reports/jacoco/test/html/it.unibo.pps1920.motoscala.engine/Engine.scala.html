<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Engine.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pps-19-motoScala</a> &gt; <a href="index.source.html" class="el_package">it.unibo.pps1920.motoscala.engine</a> &gt; <span class="el_source">Engine.scala</span></div><h1>Engine.scala</h1><pre class="source lang-java linenums">package it.unibo.pps1920.motoscala.engine


import it.unibo.pps1920.motoscala.controller.EngineController
import it.unibo.pps1920.motoscala.controller.mediation.Commandable
import it.unibo.pps1920.motoscala.controller.mediation.Event.{CommandData, CommandEvent}
import it.unibo.pps1920.motoscala.ecs.components._
import it.unibo.pps1920.motoscala.ecs.core.Coordinator
import it.unibo.pps1920.motoscala.ecs.entities._
import it.unibo.pps1920.motoscala.ecs.systems._
import it.unibo.pps1920.motoscala.ecs.util.Vector2
import it.unibo.pps1920.motoscala.engine.EngineUtils.addEntities
import it.unibo.pps1920.motoscala.engine.GameStatus._
import it.unibo.pps1920.motoscala.model.Level._
import org.slf4j.LoggerFactory
/**
 * Game Engine
 */
trait Engine extends UpdatableEngine with Commandable {
  /**
   * Sets up the game with the correct entities
   *
   * @param level entities in the level
   */
  def init(level: LevelData): Unit
  /**
   * Starts the game
   */
  def start(): Unit
  /**
   * Pauses the game
   */
  def pause(): Unit
  /**
   * Resumes the game
   */
  def resume(): Unit
  /**
   * Stops the game
   */
  def stop(): Unit
}

<span class="fc" id="L44">object GameEngine {</span>
  def apply(controller: EngineController,
            players: List[BumperCarEntity],
<span class="fc" id="L47">            difficult: Int): Engine = new GameEngineImpl(controller, players, difficult)</span>
<span class="pc" id="L48">  private class GameEngineImpl(controller: EngineController, players: List[BumperCarEntity],</span>
<span class="fc" id="L49">                               difficult: Int) extends Engine {</span>
<span class="fc" id="L50">    private val mediator = controller.mediator</span>
<span class="fc" id="L51">    private val Fps = 60</span>
<span class="pc" id="L52">    private val logger = LoggerFactory getLogger classOf[Engine]</span>
<span class="fc" id="L53">    private val gameLoop = GameLoop(Fps, this)</span>
<span class="fc" id="L54">    private val coordinator: Coordinator = Coordinator()</span>
<span class="pc" id="L55">    private val eventQueue: CommandQueue = CommandQueue()</span>

<span class="fc" id="L57">    override def tick(): Unit = coordinator.updateSystems()</span>

    override def init(level: LevelData): Unit = {
      import it.unibo.pps1920.motoscala.ecs.systems.collision.CollisionsSystem
<span class="nc" id="L61">      logger info &quot;engine init start&quot;</span>
<span class="nc" id="L62">      mediator.subscribe(this)</span>
<span class="nc" id="L63">      coordinator.registerComponentType(classOf[PositionComponent])</span>
<span class="nc" id="L64">      coordinator.registerComponentType(classOf[CollisionComponent])</span>
<span class="nc" id="L65">        .registerComponentType(classOf[ShapeComponent])</span>
<span class="nc" id="L66">        .registerComponentType(classOf[VelocityComponent])</span>
<span class="nc" id="L67">        .registerComponentType(classOf[AIComponent])</span>
<span class="nc" id="L68">        .registerComponentType(classOf[JumpComponent])</span>
<span class="nc" id="L69">        .registerComponentType(classOf[PowerUpComponent])</span>
<span class="nc" id="L70">        .registerComponentType(classOf[ScoreComponent])</span>

<span class="nc" id="L72">      coordinator.registerSystem(DrawSystem(mediator, coordinator, players.map(_.uuid)))</span>
<span class="nc" id="L73">        .registerSystem(AISystem(coordinator, eventQueue, skipFrames = 10))</span>
<span class="nc" id="L74">        .registerSystem(EndGameSystem(coordinator, controller, Vector2(level.mapSize.x, level.mapSize.y), this))</span>
<span class="nc" id="L75">        .registerSystem(PowerUpSystem(coordinator, controller, Fps))</span>
<span class="nc" id="L76">        .registerSystem(CollisionsSystem(coordinator, controller, Fps))</span>
<span class="nc" id="L77">        .registerSystem(MovementSystem(coordinator, Fps))</span>
<span class="nc" id="L78">        .registerSystem(InputSystem(coordinator, eventQueue))</span>

<span class="nc" id="L80">      logger info &quot;&quot; + level.entities</span>
<span class="nc" id="L81">      val iterablePlayers = players.iterator</span>
<span class="nc" id="L82">      addEntities(coordinator, level, iterablePlayers, difficult)</span>

<span class="nc" id="L84">      logger info &quot;engine init done&quot;</span>
    }
    override def start(): Unit = {
<span class="nc" id="L87">      gameLoop.status match {</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">        case Stopped =&gt; gameLoop.start()</span>
<span class="nc" id="L89">        case _ =&gt; logger error &quot;GameLoop already started&quot;</span>
      }
    }
<span class="nc" id="L92">    override def pause(): Unit = gameLoop.pause()</span>
<span class="nc" id="L93">    override def resume(): Unit = gameLoop.unPause()</span>
    override def stop(): Unit = {
<span class="fc" id="L95">      gameLoop.halt()</span>
<span class="fc" id="L96">      mediator.unsubscribe(this)</span>
    }

    override def notifyCommand(data: CommandData): Unit = {
<span class="nc" id="L100">      eventQueue.enqueue(CommandEvent(data))</span>
    }
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>