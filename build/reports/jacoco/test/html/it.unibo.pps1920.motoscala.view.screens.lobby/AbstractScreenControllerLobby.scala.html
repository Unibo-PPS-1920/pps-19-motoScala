<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractScreenControllerLobby.scala</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pps-19-motoScala</a> &gt; <a href="index.source.html" class="el_package">it.unibo.pps1920.motoscala.view.screens.lobby</a> &gt; <span class="el_source">AbstractScreenControllerLobby.scala</span></div><h1>AbstractScreenControllerLobby.scala</h1><pre class="source lang-java linenums">package it.unibo.pps1920.motoscala.view.screens.lobby

import it.unibo.pps1920.motoscala.controller.ObservableUI
import it.unibo.pps1920.motoscala.multiplayer.messages.DataType.LobbyData
import it.unibo.pps1920.motoscala.view.ViewFacade
import it.unibo.pps1920.motoscala.view.fsm.ChangeScreenEvent
import it.unibo.pps1920.motoscala.view.screens.ScreenController
import it.unibo.pps1920.motoscala.view.utilities.ViewUtils.addButtonMusic
import javafx.event.ActionEvent
import javafx.fxml.FXML
import javafx.scene.control.{SplitMenuButton, _}
import javafx.scene.layout.BorderPane
import scalafx.scene.paint.Color

import scala.jdk.CollectionConverters._

/** Abstract ScreenController dedicated to show the multiplayer lobby.
 *
 * @param viewFacade the view facade
 * @param controller the controller
 */
<span class="nc" id="L22">protected[lobby] abstract class AbstractScreenControllerLobby(</span>
<span class="nc" id="L23">  protected override val viewFacade: ViewFacade,</span>
<span class="nc" id="L24">  protected override val controller: ObservableUI) extends ScreenController(viewFacade, controller) {</span>

<span class="nc" id="L26">  @FXML protected var root: BorderPane = _</span>
<span class="nc" id="L27">  @FXML protected var mainBorderPane: BorderPane = _</span>
<span class="nc" id="L28">  @FXML protected var buttonKick: Button = _</span>
<span class="nc" id="L29">  @FXML protected var buttonReady: Button = _</span>
<span class="nc" id="L30">  @FXML protected var buttonStart: Button = _</span>
<span class="nc" id="L31">  @FXML protected var dropMenuDifficult: SplitMenuButton = _</span>
<span class="nc" id="L32">  @FXML protected var dropMenuLevel: SplitMenuButton = _</span>
<span class="nc" id="L33">  @FXML protected var listPlayer: ListView[Label] = _</span>
<span class="nc" id="L34">  @FXML protected var ipLabel: Label = _</span>
<span class="nc" id="L35">  @FXML protected var portLabel: Label = _</span>

<span class="nc" id="L37">  override def whenDisplayed(): Unit = {</span>
  }
  @FXML override def initialize(): Unit = {
<span class="nc" id="L40">    assertNodeInjected(root, mainBorderPane, buttonKick, buttonReady, buttonStart)</span>
<span class="nc" id="L41">    extendButtonBackBehaviour()</span>
<span class="nc" id="L42">    initBackButton()</span>
<span class="nc" id="L43">    initButtons()</span>
<span class="nc" id="L44">    initSplitMenus()</span>
  }
  private def initSplitMenus(): Unit = {
<span class="nc" id="L47">    listPlayer.getSelectionModel.selectedItemProperty().addListener((_, _, newVal) =&gt; {</span>
<span class="nc bnc" id="L48" title="All 8 branches missed.">      if (newVal != null &amp;&amp; listPlayer.getItems.get(0) != newVal) buttonKick.setDisable(false)</span>
<span class="nc" id="L49">      else buttonKick.setDisable(true)</span>
    })
  }
  private def initButtons(): Unit = {
<span class="nc" id="L53">    addButtonMusic(buttonReady, buttonKick, buttonStart)(controller)</span>
<span class="nc" id="L54">    buttonReady.setOnAction(_ =&gt; controller.lobbyInfoChanged(isStatusChanged = true))</span>
<span class="nc" id="L55">    buttonKick.setOnAction(_ =&gt; controller.kickSomeone(listPlayer.getSelectionModel.getSelectedItem.getText))</span>
<span class="nc" id="L56">    buttonStart.setOnAction(_ =&gt; {</span>
<span class="nc" id="L57">      cleanAll()</span>
<span class="nc" id="L58">      controller.startMultiplayerGame()</span>
<span class="nc" id="L59">      viewFacade.changeScreen(ChangeScreenEvent.GotoGame)</span>
    })
<span class="nc" id="L61">    buttonReady.setDisable(false)</span>
  }
  private def extendButtonBackBehaviour(): Unit = {
<span class="nc" id="L64">    buttonBack.addEventHandler[ActionEvent](ActionEvent.ACTION, _ =&gt; {</span>
<span class="nc" id="L65">      cleanAll()</span>
<span class="nc" id="L66">      controller.leaveLobby()</span>
    })
  }
<span class="nc" id="L69">  protected def leaveLobby(): Unit = viewFacade.changeScreen(ChangeScreenEvent.GoBack)</span>
  protected def updateLobby(lobbyData: LobbyData): Unit = {
<span class="nc" id="L71">    lobbyData.difficulty.foreach(diff =&gt; dropMenuDifficult.setText(diff.toString))</span>
<span class="nc" id="L72">    lobbyData.level.foreach(lvl =&gt; dropMenuLevel.setText(lvl.toString))</span>
<span class="nc" id="L73">    val rpValues = lobbyData.readyPlayers.values</span>
<span class="nc bnc" id="L74" title="All 8 branches missed.">    if (rpValues.nonEmpty &amp;&amp; (rpValues.map(pd =&gt; pd.status).count(s =&gt; !s) == 0) &amp;&amp; rpValues.size &gt; 1)</span>
<span class="nc" id="L75">      buttonStart.setDisable(false)</span>
<span class="nc" id="L76">    else buttonStart.setDisable(true)</span>
<span class="nc" id="L77">    val lisPlayerStatus = listPlayer.getItems</span>
<span class="nc" id="L78">    lisPlayerStatus.clear()</span>
<span class="nc" id="L79">    val players: java.util.List[Label] = lobbyData.readyPlayers.values.map(player =&gt; {</span>
<span class="nc" id="L80">      val label = new Label(player.name)</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">      if (player.status) label.setTextFill(Color.Green) else label.setTextFill(Color.Red)</span>
<span class="nc" id="L82">      label</span>
<span class="nc" id="L83">    }).toList.asJava</span>
<span class="nc" id="L84">    lisPlayerStatus.addAll(players)</span>
  }
<span class="nc" id="L86">  protected def startMulti(): Unit = viewFacade.changeScreen(ChangeScreenEvent.GotoGame)</span>
  protected def setIpAndPort(ip: String, port: String, name: String, levels: List[Int],
                             difficulties: List[Int]): Unit = {
<span class="nc" id="L89">    enableAll()</span>
<span class="nc" id="L90">    dropMenuLevel.getItems.addAll(levels.map(lvl =&gt; new MenuItem(lvl.toString)).asJava)</span>
<span class="nc" id="L91">    dropMenuDifficult.getItems.addAll(difficulties.map(diff =&gt; new MenuItem(diff.toString)).asJava)</span>

    def initSplitMenuButton(dropMenu: SplitMenuButton)
                           (controllerStrategy: (ObservableUI, Option[Int]) =&gt; Unit): Unit = {
<span class="nc" id="L95">      dropMenu.getItems.forEach(_.setOnAction(el =&gt; {</span>
<span class="nc" id="L96">        val lvl = el.getSource.asInstanceOf[MenuItem].getText</span>
<span class="nc" id="L97">        dropMenu.setText(lvl)</span>
<span class="nc" id="L98">        controllerStrategy(controller, Some(lvl.toInt))</span>
      }))
    }
<span class="nc" id="L101">    initSplitMenuButton(dropMenuLevel)((controller, lvl) =&gt; controller.lobbyInfoChanged(level = lvl))</span>
<span class="nc" id="L102">    initSplitMenuButton(dropMenuDifficult)((controller, diff) =&gt; controller.lobbyInfoChanged(difficult = diff))</span>

<span class="nc" id="L104">    controller.lobbyInfoChanged(level = Some(1), difficult = Some(1))</span>

<span class="nc" id="L106">    dropMenuLevel.setText(levels.head.toString)</span>
<span class="nc" id="L107">    dropMenuDifficult.setText(difficulties.head.toString)</span>

<span class="nc" id="L109">    ipLabel.setText(s&quot;${ipLabel.getText}$ip&quot;)</span>
<span class="nc" id="L110">    portLabel.setText(s&quot;${portLabel.getText} $port&quot;)</span>
<span class="nc" id="L111">    val label = new Label(name)</span>
<span class="nc" id="L112">    label.setTextFill(Color.Red)</span>
<span class="nc" id="L113">    listPlayer.getItems.add(label)</span>
  }
  private def enableAll(): Unit = {
<span class="nc" id="L116">    cleanAll()</span>
<span class="nc" id="L117">    dropMenuDifficult.getItems.clear()</span>
<span class="nc" id="L118">    dropMenuLevel.getItems.clear()</span>
<span class="nc" id="L119">    dropMenuDifficult.setDisable(false)</span>
<span class="nc" id="L120">    dropMenuLevel.setDisable(false)</span>
<span class="nc" id="L121">    buttonStart.setDisable(false)</span>
<span class="nc" id="L122">    buttonKick.setVisible(true)</span>
<span class="nc" id="L123">    buttonStart.setVisible(true)</span>
<span class="nc" id="L124">    ipLabel.setVisible(true)</span>
<span class="nc" id="L125">    portLabel.setVisible(true)</span>

  }
  private def cleanAll(): Unit = {
<span class="nc" id="L129">    buttonKick.setDisable(true)</span>
<span class="nc" id="L130">    buttonStart.setDisable(true)</span>
<span class="nc" id="L131">    buttonKick.setVisible(false)</span>
<span class="nc" id="L132">    buttonStart.setVisible(false)</span>
<span class="nc" id="L133">    listPlayer.getItems.clear()</span>
<span class="nc" id="L134">    ipLabel.setVisible(false)</span>
<span class="nc" id="L135">    portLabel.setVisible(false)</span>
<span class="nc" id="L136">    dropMenuDifficult.setDisable(true)</span>
<span class="nc" id="L137">    dropMenuLevel.setDisable(true)</span>
<span class="nc" id="L138">    ipLabel.setText(&quot;Ip:&quot;)</span>
<span class="nc" id="L139">    portLabel.setText(&quot;Port:&quot;)</span>
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>